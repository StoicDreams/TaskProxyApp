"use strict";{const notFound="\n    ## Not Found\n\n    The page you were looking for was not found.\n    ";let comp=null,markdown="",myId="",myFile="",segments=[];async function loadProject(){myId=location.pathname.substring(1),myFile=`pages/${myId}.md`;let md=await webui.proxy.getProjectFile(myFile,(err=>{webui.log.warn("getProjectFile:%o",err)}));md||(md="",await webui.proxy.saveProjectFile(myFile,md)),setMarkdown(md)}function setupBar(isEnd){let bar=webui.create("webui-flex",{justify:"right"}),btnSave=webui.create("webui-button",{html:"Save",title:"Save Page","start-icon":"save",theme:"primary"});btnSave.addEventListener("click",(async _=>{if(!myFile)return;let md=[];comp.querySelectorAll("app-markdown-segment").forEach((segment=>{segment.parentNode===comp&&md.push(segment.getMarkdown())}));let result=await webui.proxy.saveProjectFile(myFile,md.join("\n\n").trim());result&&webui.alert(result,"success")}));let btnAdd=webui.create("webui-button",{html:"Add",title:"Add Segment","start-icon":"star",theme:"secondary"});return btnAdd.addEventListener("click",(async _=>{let segment=webui.create("app-markdown-segment",{});isEnd?bar.before(segment):bar.after(segment),addSegmentEvents(segment),segments=Array.from(comp.querySelectorAll("app-markdown-segment"))})),bar.appendChild(btnAdd),bar.appendChild(btnSave),bar}let topBar=setupBar(!1),bottomBar=setupBar(!0);function addSegmentEvents(segment){let canStart=!1,ismoving=!1,mouseisdown=!1,offsetX=0,offsetY=0,placeholder=webui.create("div",{class:"placeholder"});function onMove(event){if(mouseisdown){if(ismoving){let left=event.clientX-offsetX,top=event.clientY-offsetY;segment.style.left=`${left}px`,segment.style.top=`${top}px`;let closest=null,minDistance=1/0,aboveOrBelow=null;return segments.forEach((el=>{if(el===segment)return;const rect=el.getBoundingClientRect(),centerY=rect.top+rect.height/2,distance=Math.abs(event.clientY-centerY);distance<minDistance&&(minDistance=distance,closest=el,aboveOrBelow=event.clientY<centerY?"above":"below")})),void("below"===aboveOrBelow?closest.after(placeholder):closest.before(placeholder))}canStart&&(ismoving=!0,canStart=!1,document.body.classList.add("dragging"),segment.style.width=`${segment.clientWidth}px`,segment.style.height=`${segment.clientHeight}px`,segment.classList.add("moving"),segment.before(placeholder),document.getSelection?document.getSelection().empty():window.getSelection&&window.getSelection().removeAllRanges())}}function onRemove(ev){mouseisdown=!1,placeholder.before(segment),document.removeEventListener("mousemove",onMove),document.removeEventListener("mouseup",onRemove),segment.classList.remove("moving"),segment.style.left="",segment.style.top="",segment.style.width="",segment.style.height="",placeholder.remove(),ismoving=!1,canStart=!1,document.body.classList.remove("dragging")}segment.addEventListener("mousedown",(ev=>{if(1!==ev.buttons||mouseisdown)return;if(!webui.closest(ev,".drag-handle"))return;mouseisdown=!0;let cs=segment.getClientRects()[0];offsetX=ev.clientX-cs.x,offsetY=ev.clientY-cs.y,setTimeout((()=>{mouseisdown&&(canStart=!0)}),200),document.addEventListener("mousemove",onMove),document.addEventListener("mouseup",onRemove,{once:!0})}))}function setMarkdown(md){markdown=md,comp.innerHTML="",convertMarkdownToSegments(markdown),comp.appendChild(topBar),segments.forEach((segment=>{addSegmentEvents(segment),comp.appendChild(segment)})),comp.appendChild(bottomBar)}const segmentType={INVALID:0,EMTPY:1,RAW:2,COMPONENT:3,COMPONENTSTART:4,COMPONENTEND:5};function getSegmentDetail(line){if(""===line.trim())return[segmentType.EMTPY,{mdt:"empty"}];if(line.startsWith("#"))return[segmentType.RAW,{mdt:"heading"}];if(line.match(/<([^ >]+)[^>]*>.*<\/\1>\s*$/))return[segmentType.COMPONENT,{mdt:"sl-comp"}];let match=line.match(/<\/([^ >]+)[^>]*>/);if(match){let[_,tag]=match;return[segmentType.COMPONENTEND,{tag:tag}]}if(match=line.match(/<([^ >]+)[^>]*>/),match){let[_,tag]=match;return[segmentType.COMPONENTSTART,{tag:tag}]}return[segmentType.RAW,{mdt:"text"}]}function convertMarkdownToSegments(markdown){segments.length=0;let lines=markdown.replace(/\r\n/g,"\n").split("\n"),s=[],currentSegment=null,tag=null,last=null;for(let index=0;index<lines.length;++index){let line=lines[index],[st,options]=getSegmentDetail(line),prev=last;switch(last=st,st){case segmentType.INVALID:break;case segmentType.COMPONENTSTART:currentSegment||(currentSegment=webui.create("app-markdown-segment"),tag=options.tag),s.push(line);break;case segmentType.COMPONENTEND:if(!currentSegment)continue;s.push(line);let md=s.join("\n"),ms=webui.create("app-markdown-segment",{"data-markdown":md,mdt:"ml-comp"});segments.push(ms),s.length=0,currentSegment=null;break;default:if(currentSegment)s.push(line);else{if(st===segmentType.EMTPY&&prev!==segmentType.EMTPY)continue;options["data-markdown"]=line;let ms=webui.create("app-markdown-segment",options);segments.push(ms)}}}}webui.define("app-page-handler",{preload:"app-markdown-segment webui-dropdown webui-input-text webui-input-message",constructor:t=>{comp=t},connected:function(t){let project=webui.getData("app-current-project");project&&project.value?loadProject():setMarkdown(notFound)},disconnected:function(t){comp=null,markdown="",myId="",myFile="",segments=[]}})}